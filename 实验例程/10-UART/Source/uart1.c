/*********************************************************************************************
* 文件：uart.c
* 作者：Meixin 2017.09.26
* 说明：串口驱动代码
* 修改：
* 注释：
*********************************************************************************************/

/*********************************************************************************************
* 头文件
*********************************************************************************************/
#include "uart1.h"

/*********************************************************************************************
* 定义
*********************************************************************************************/
char recvBuf[256];                                              //收到的数据存储在数组里
int recvCnt = 0;                                                //收到数据的数量

/*********************************************************************************************
* 名称：uart1_init(unsigned char StopBits,unsigned char Parity)
* 功能：串口0初始化
* 参数：无
* 返回：无
* 修改：
* 注释：
****************************************** 
*    CC253O 32M系统时钟波特率参数表      * 
*----------------------------------------* 
*  波特率  UxBAUD         UxGCRM         * 
*  240     59             6              * 
*  4800    59             7              * 
*  9600    59             8              * 
*  14400   216            8              * 
*  19200   59             9              * 
*  28800   216            9              * 
*  38400   59             10             * 
*  57600   216            10             * 
*  76800   59             11             * 
*  115200  216            11             * 
*  23040   216            12             * 
****************************************** 
*********************************************************************************************/
void uart1_init(unsigned char StopBits,unsigned char Parity)
{
  P1SEL |=  0xC0;                                               //初始化UART1端口
  PERCFG |= 0x02;                                               //选择UART1为可选位置一
  P2SEL &= ~0x20;                                               //P1优先作为串口1
  U1CSR = 0xC0;                                                 //设置为UART模式,而且使能接受器
   
  U1GCR = 10;                  
  U1BAUD = 59;                                                  //波特率设置为38400
  
  U1UCR |= StopBits|Parity;                                     //设置停止位与奇偶校验
}

/*********************************************************************************************
* 名称：uart1_send_char()
* 功能：串口发送字节函数
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void uart1_send_char(char ch)
{
  U1DBUF = ch;                                                  //将要发送的数据填入发送缓存寄存器
  while(UTX1IF == 0);                                           //等待数据发送完成
  UTX1IF = 0;                                                   //发送完成后将数据清零
}

/*********************************************************************************************
* 名称：uart1_send_string(char *Data)
* 功能：串口发送字符串函数
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void uart1_send_string(char *Data)
{  
  while (*Data != '\0')                                         //如果检测到空字符则跳出
  {
    uart1_send_char(*Data++);                                  //循环发送数据
  }
}

/*********************************************************************************************
* 名称：int uart1_recv_char()
* 功能：串口接收字节函数
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
int uart1_recv_char(void)
{
  int ch;                                                       //等待数据接收完成
  while (URX1IF == 0);                                          //提取接受数据
  ch = U1DBUF;
  URX1IF = 0;                                                   //发送标志位清零
  return ch;                                                    //返回获取到的串口数据
}

/*********************************************************************************************
* 名称：uart1_test()
* 功能：串口打印函数
* 参数：无
* 返回：无
* 修改：
* 注释：
*********************************************************************************************/
void uart1_test(void)
{
  unsigned char ch;
  ch = uart1_recv_char();				        //接收串口接收到的字节
  if (ch == '@' || recvCnt >= 256) {                            //接收数据以@字符或者大于等于256结束
    recvBuf[recvCnt] = 0;
    uart1_send_string(recvBuf);				        //串口发送字符串函数
    uart1_send_string("\r\n");
    recvCnt = 0;					        //收到数据清空
  } else {
    recvBuf[recvCnt++] = ch;				        //用数组储存接收到的数据
  }
}